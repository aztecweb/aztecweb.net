#!/bin/bash

# Verify if Composer is installed
if ! composer --version > /dev/null 2>&1; then
    echo 'Composer is required to run the script.';
    exit 1;
fi

# Verify if grunt-cli is installed
if ! grunt --version > /dev/null 2>&1; then
    echo 'grunt-cli is required to run the script.';
    exit 1;
fi

# Verify if Bower is installed
if ! bower --version > /dev/null 2>&1; then
    echo 'Bower is required to run the script.';
    exit 1;
fi

# Install packages defined by composer.json file
composer install

WP_CLI='vendor/bin/wp'

# Verify if the WordPress is downloaded
if [ ! -f public/wp-load.php ]; then
    echo 'Downloading WordPress'
    $WP_CLI core download
fi

# Generate env salts file
if [ ! -f .salts ]; then
	$WP_CLI dotenv salts generate --file='.salts'
fi

# Install the WordPress if it isn't
if ! $WP_CLI core is-installed 2> /dev/null; then
    $WP_CLI db reset --yes 2> /dev/null || $WP_CLI db create
    $WP_CLI core install
fi

# Install extra plugins
plugins=extra/plugins/*.zip
if [ $(ls -la ${plugins} 2> /dev/null | wc -l) -gt 0 ]; then # verify if has packages inner the directory
    for plugin in $plugins
    do
        if ! $WP_CLI plugin is-installed $(basename $plugin .zip); then
            $WP_CLI plugin install $plugin
        fi
    done
fi

# Install extra themes
themes=extra/themes/*.zip
if [ $(ls -la ${themes} 2> /dev/null | wc -l) -gt 0 ]; then # verify if has packages inner the directory
    for theme in $themes
    do
        if ! $WP_CLI theme is-installed $(basename $theme .zip); then
            $WP_CLI theme install $theme
        fi
    done
fi

# Activate all plugins
$WP_CLI plugin activate --all

# Update language of core, theme and plugins
$WP_CLI core language update

# Install NPM and Bower dependencies
npm install
bower install
